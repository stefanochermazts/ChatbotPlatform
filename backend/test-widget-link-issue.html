<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Widget Link Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .input { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .output { background: #e8f5e8; padding: 10px; margin: 10px 0; }
        .error { background: #ffe8e8; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Test Widget Link Issue - Caso Specifico CIE</h1>
    
    <div class="test-section">
        <h2>Test 1: Caso Esatto dell'Utente</h2>
        <div class="input">
            <strong>Input problematico:</strong><br>
            Per ulteriori dettagli, puoi consultare la pagina ufficiale del Comune di San Cesareo [qui](http://www.comune.sancesareo.rm.it/c058119/zf/index.php/servizi-aggiuntivi/index/index/idtesto/20247
        </div>
        <div class="output" id="test1-output">
            <strong>Output:</strong> <span id="test1-result">In elaborazione...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>Test 2: Link con Parentesi Corretta</h2>
        <div class="input">
            <strong>Input corretto:</strong><br>
            Per ulteriori dettagli, puoi consultare la pagina ufficiale del Comune di San Cesareo [qui](http://www.comune.sancesareo.rm.it/c058119/zf/index.php/servizi-aggiuntivi/index/index/idtesto/20247)
        </div>
        <div class="output" id="test2-output">
            <strong>Output:</strong> <span id="test2-result">In elaborazione...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>Test 3: Varianti del Problema</h2>
        <div class="input">
            <strong>Input varianti:</strong><br>
            <div id="test3-inputs"></div>
        </div>
        <div class="output" id="test3-output">
            <strong>Output:</strong> <span id="test3-result">In elaborazione...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>Analisi Regex</h2>
        <div id="regex-analysis"></div>
    </div>

    <script>
        // Copiamo esattamente la logica del widget per il test
        function simulateWidgetMarkdownParsing(text) {
            let html = text;
            
            console.log('üîç Input originale:', text);
            
            // Escape HTML di base
            html = html.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');
            
            // 6a. Fix link markdown malformati (senza parentesi di chiusura)
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^)\s]+)(?=\s|$|\n)/g, (match, text, url) => {
                console.info('üîß Fix 6a - Malformed link:', match, '‚Üí', `[${text}](${url})`);
                return `[${text}](${url})`;
            });
            
            // 6a2. Fix specifico per URL che finiscono con numeri
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^)]*\/\d+)(?=\s|$|\n)/g, (match, text, url) => {
                console.warn('üîß Fix 6a2 - URL ending with numbers:', match, '‚Üí', `[${text}](${url})`);
                return `[${text}](${url})`;
            });

            // 6b. Links markdown [text](url) - gestisce URL completi 
            html = html.replace(/\[([^\]]+)\]\(([^)\s]+(?:\s[^)]*)?)\)/g, (match, text, url) => {
                console.log('üîß Processing complete link:', match);
                
                // CRITICAL FIX: Pulisce l'URL ma preserva integrit√†
                let cleanUrl = url.trim();
                
                // Rimuovi solo caratteri di punteggiatura finali MA solo se l'URL non finisce con numeri
                if (/[.,;:!?"'>]$/.test(cleanUrl) && !/\/\d+$/.test(cleanUrl)) {
                  cleanUrl = cleanUrl.replace(/[.,;:!?"'>]+$/, '');
                  console.log('üßπ URL cleaned:', url, '‚Üí', cleanUrl);
                }
                
                // Validazione URL
                let finalUrl;
                if (cleanUrl.match(/^https?:\/\//)) {
                  finalUrl = cleanUrl;
                } else {
                  console.warn('üîç Invalid URL:', cleanUrl);
                  return `${text} (${cleanUrl})`;
                }
                
                console.log('‚úÖ Final link:', `[${text}](${finalUrl})`);
                return `<a href="${finalUrl}" target="_blank" rel="noopener noreferrer" class="chatbot-link">${text}</a>`;
            });
            
            console.log('üèÅ Final HTML:', html);
            return html;
        }

        // Test cases
        const testCases = [
            {
                name: "Caso Utente - Link senza parentesi finale",
                input: "Per ulteriori dettagli, puoi consultare la pagina ufficiale del Comune di San Cesareo [qui](http://www.comune.sancesareo.rm.it/c058119/zf/index.php/servizi-aggiuntivi/index/index/idtesto/20247",
                expectedFix: true
            },
            {
                name: "Link corretto con parentesi",
                input: "Per ulteriori dettagli, puoi consultare la pagina ufficiale del Comune di San Cesareo [qui](http://www.comune.sancesareo.rm.it/c058119/zf/index.php/servizi-aggiuntivi/index/index/idtesto/20247)",
                expectedFix: false
            },
            {
                name: "Link senza parentesi + spazio",
                input: "Visita [questo link](http://www.comune.sancesareo.rm.it/c058119/zf/index.php/servizi-aggiuntivi/index/index/idtesto/20247 per maggiori info",
                expectedFix: true
            },
            {
                name: "Link senza parentesi + fine stringa",
                input: "Maggiori dettagli su [questa pagina](http://www.comune.sancesareo.rm.it/c058119/zf/index.php/servizi-aggiuntivi/index/index/idtesto/20247",
                expectedFix: true
            }
        ];

        // Esegui test
        function runTests() {
            console.clear();
            console.log('üß™ Iniziando test widget link parsing...');
            
            testCases.forEach((testCase, index) => {
                console.log(`\n=== TEST ${index + 1}: ${testCase.name} ===`);
                
                const result = simulateWidgetMarkdownParsing(testCase.input);
                
                // Verifica se contiene link validi
                const linkMatches = result.match(/<a[^>]*href="([^"]*)"[^>]*>([^<]*)<\/a>/g);
                const hasValidLinks = linkMatches && linkMatches.length > 0;
                
                // Analizza link
                if (linkMatches) {
                    linkMatches.forEach(link => {
                        const hrefMatch = link.match(/href="([^"]*)"/);
                        if (hrefMatch) {
                            const url = hrefMatch[1];
                            console.log('üîó Link estratto:', url);
                            
                            // Verifica se √® un URL completo e valido
                            try {
                                new URL(url);
                                console.log('‚úÖ URL valido');
                            } catch (e) {
                                console.error('‚ùå URL non valido:', e.message);
                            }
                        }
                    });
                }
                
                // Aggiorna UI
                const outputElement = document.getElementById(`test${index + 1}-result`);
                if (outputElement) {
                    outputElement.innerHTML = hasValidLinks ? 
                        `‚úÖ Link processato: ${linkMatches.length} link trovati` : 
                        `‚ùå Nessun link valido generato`;
                }
                
                // Mostra HTML risultante
                const outputDiv = document.getElementById(`test${index + 1}-output`);
                if (outputDiv) {
                    const resultDiv = document.createElement('div');
                    resultDiv.innerHTML = '<strong>HTML risultante:</strong><br>' + result;
                    outputDiv.appendChild(resultDiv);
                }
            });
            
            // Analisi regex dettagliata
            analyzeRegexBehavior();
        }

        function analyzeRegexBehavior() {
            const analysisDiv = document.getElementById('regex-analysis');
            
            const problematicInput = "testo [link](http://example.com/path/123";
            
            let analysis = '<h3>üîç Analisi Dettagliata Regex</h3>';
            analysis += `<p><strong>Input problematico:</strong> ${problematicInput}</p>`;
            
            // Test delle singole regex
            const regex1 = /\[([^\]]+)\]\((https?:\/\/[^)\s]+)(?=\s|$|\n)/g;
            const regex2 = /\[([^\]]+)\]\((https?:\/\/[^)]*\/\d+)(?=\s|$|\n)/g;
            const regex3 = /\[([^\]]+)\]\(([^)\s]+(?:\s[^)]*)?)\)/g;
            
            analysis += '<h4>Test Regex 1 (Fix malformati base):</h4>';
            const match1 = problematicInput.match(regex1);
            analysis += `<p>Match: ${match1 ? JSON.stringify(match1) : 'Nessun match'}</p>`;
            
            analysis += '<h4>Test Regex 2 (Fix specifico numeri):</h4>';
            const match2 = problematicInput.match(regex2);
            analysis += `<p>Match: ${match2 ? JSON.stringify(match2) : 'Nessun match'}</p>`;
            
            analysis += '<h4>Test Regex 3 (Link completi):</h4>';
            const match3 = problematicInput.match(regex3);
            analysis += `<p>Match: ${match3 ? JSON.stringify(match3) : 'Nessun match'}</p>`;
            
            analysisDiv.innerHTML = analysis;
        }

        // Popola test 3 con varianti
        function populateVariantTests() {
            const variants = [
                "Link alla fine: [test](http://example.com/123",
                "Link con spazio: [test](http://example.com/123 seguito da testo",
                "Link con newline: [test](http://example.com/123\naltro testo",
                "Link normale: [test](http://example.com/123) normale"
            ];
            
            document.getElementById('test3-inputs').innerHTML = variants.map(v => `<div>${v}</div>`).join('');
            
            let results = [];
            variants.forEach(variant => {
                const result = simulateWidgetMarkdownParsing(variant);
                const hasLink = result.includes('<a href=');
                results.push(`${hasLink ? '‚úÖ' : '‚ùå'} ${variant.substring(0, 30)}...`);
            });
            
            document.getElementById('test3-result').innerHTML = results.join('<br>');
        }

        // Avvia i test quando la pagina √® caricata
        document.addEventListener('DOMContentLoaded', function() {
            populateVariantTests();
            runTests();
        });
    </script>
</body>
</html>
